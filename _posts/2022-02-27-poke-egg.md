---
layout: post
title: Pokemon孵蛋问题分析
tags: Python3
required: code python
---

本方法基于[Pokemon BDSP](https://zh.wikipedia.org/wiki/寶可夢_晶燦鑽石%EF%BC%8F明亮珍珠)分析。

# 1. 孵蛋概率计算

## 1.1 问题分析

在孵蛋过程中一般会给亲代Pokemon分别携带[红线](https://wiki.52poke.com/wiki/红线)和[不变之石](https://wiki.52poke.com/wiki/不变之石)，以便高效遗传亲代的个体值以及固定子代性格。根据红线的道具效果，子代Pokemon的六项能力值中的五项会随机遗传自亲代。所以只有亲代有的V才会遗传(非常符合生物学关系)，子代永远不会遗传亲代里不存在的V(除了随机项产生，即变异)。因此，我们便可以根据遗传规则设计计算孵出指定V或者V数概率的算法。

## 1.2 算法设计

```python
def calcEggs(fatherV: str, motherV: str, childV, maleRate: float, eggType: str) -> int:
    # prepare child V list
    if isinstance(childV, int):
        childVs = list(combinations(Vs, childV))
    elif isinstance(childV, str) and set(childV) < set(Vs):
        childVs = [tuple(childV)]
    else:
        raise RuntimeError('invalid setting for child.')
    # calculate probability
    totalProb = 0
    for childV in childVs:
        tempTotalProb = 0
        for chosenV in combinations(Vs, 5):
            eachProb = 1
            for v in childV:
                itemProb = 0
                if v in chosenV:
                    if v in fatherV: itemProb += 0.5
                    if v in motherV: itemProb += 0.5
                else:
                    itemProb = 1 / 32
                eachProb *= itemProb
            tempTotalProb += eachProb
        tempTotalProb /= 6
        totalProb += tempTotalProb
    # after work
    if eggType == 'male':
        finalProb = totalProb * maleRate
    elif eggType == 'female':
        finalProb = totalProb * (1 - maleRate)
    elif eggType == 'both':
        finalProb = totalProb
    else:
        raise RuntimeError('invalid egg type.')
    try:
        return int (1 / finalProb) + 1
    except ZeroDivisionError:
        return float('inf')
```

## 1.3 结果分析

假如我们有一只6V的父代，那么母代V数与子代V数的对应关系如下(其中行为母代V数，列为子代V数，即6V父代和0V母代为了孵出5V子代需要约25颗蛋)。

|     | 0   | 1   | 2   | 3   | 4   | 5   |
| :-- | :-- | :-- | :-- | :-- | :-- | :-- |
| 0   | 3   | 3   | 3   | 3   | 3   | 3   |
| 1   | 1   | 1   | 1   | 1   | 1   | 1   |
| 2   | 1   | 1   | 1   | 1   | 1   | 1   |
| 3   | 2   | 2   | 1   | 1   | 1   | 1   |
| 4   | 6   | 4   | 3   | 2   | 1   | 1   |
| 5   | 25  | 14  | 8   | 5   | 3   | 2   |

但如果将父代减为5V，则对应蛋数就会相应变大(测试用例：父代为HABCD，母代为父代所包含的0V~5V)。

|     | 0   | 1   | 2   | 3   | 4   | 5   |
| :-- | :-- | :-- | :-- | :-- | :-- | :-- |
| 0   | 3   | 3   | 3   | 3   | 3   | 3   |
| 1   | 1   | 1   | 1   | 1   | 1   | 1   |
| 2   | 2   | 1   | 1   | 1   | 1   | 1   |
| 3   | 3   | 2   | 2   | 1   | 1   | 1   |
| 4   | 17  | 10  | 6   | 4   | 2   | 2   |
| 5   | 119 | 62  | 33  | 17  | 9   | 5   |

基于以上两种情况我们可以利用类似CYK算法，通过不断更新下三角部的数据的方式进行最优化求解。

```python
def solveWithCYK(eggMat: list, start: int, end: int) -> str:
    eggMat = [[(n, col) for col in row] for n, row in enumerate(eggMat)]
    # CYK
    for step in range(2, 6):
        for src in range(6 - step):
            dst = src + step
            for mid in range(src + 1, dst):
                assumedEggNum = eggMat[src][mid][1] + eggMat[mid][dst][1]
                if assumedEggNum < eggMat[src][dst][1]:
                    eggMat[src][dst] = (mid, assumedEggNum)
    # track path
    path = [start]
    while path[-1] != (node := eggMat[path[-1]][end][0]):
        path.append(node)
    path.append(end)
    path = ' -> '.join(str(idx) for idx in path)
    eggs = f': {eggMat[start][end][1]}'
    return path + eggs
```

运行后可发现，如果拥有5V父代，我们可以通过$0\to1\to3\to4\to5$的方式更新母代，从而在孵化约16颗蛋时得到任意性别的5V子代。但如果我们拥有6V的父代，则只需要以$0\to2\to3\to5$的方式孵7颗蛋就能得到5V子代。

尽管6V的父代可大幅减少所需孵蛋总数，但得到6V父代的过程却远难于得到5V子代。完全基于概率考虑，5V父代和5V母代为了孵出6V子代需要约193颗蛋，即便6V父代和5V母代仍需要约110颗蛋。因此若非平时孵化过程中得到了6V子代，否则直接以孵化6V为目标并非上策。

## 1.4 在线执行

<py-script src="/assets/src/poke-egg/poke-egg.py"></py-script>
<py-script>
def buttonClick(event):
    fatherV = Element('father-v').element.value
    motherV = int(Element('mother-v').element.value)
    childV = int(Element('child-v').element.value)
    maleRate = float(Element('male-rate').element.value)
    pyscript.write('calc-res', solve(fatherV, motherV, childV, maleRate))
</py-script>
<div>
    <div>父代V项：<span><input class="py-input" id="father-v"></span>(HABCDS可选)</div>
    <div>母代V数：<span><input class="py-input" id="mother-v"></span>(0~5可选)</div>
    <div>子代V数：<span><input class="py-input" id="child-v"></span>(0~5可选)</div>
    <div>雌雄比：<span><input class="py-input" id="male-rate"></span>(0~1可选)</div>
    <button id="calc-btn" py-onClick="buttonClick">execute</button>
    <p id="calc-res"></p>
</div>

以上出现的完整代码可点击[此链接](/assets/src/poke-egg/poke-egg.py)下载。

# 2. 孵蛋链总图

![chain](/assets/src/poke-egg/chain.svg)

在整条链中尽量选择了**容易获得**、**性别比例平均**、**孵蛋步数较低**的Pokemon，除无性别组(巨金怪/3D龙等)以外均可采取上述办法。此外，由于矿物组不常见也不常用，故排除在外。

# 3. 工具Pokemon获得途径以及孵蛋步数

- [盾甲龙](https://wiki.52poke.com/wiki/盾甲龙)：化石复活
- [咩利羊](https://wiki.52poke.com/wiki/咩利羊)：地下洞窟，5140步
- [卷卷耳](https://wiki.52poke.com/wiki/卷卷耳)：百代森林/地下洞窟，5140步
- [帕奇利兹](https://wiki.52poke.com/wiki/帕奇利兹)：山谷发电厂/地下洞窟，2570步
- [大牙狸](https://wiki.52poke.com/wiki/大牙狸)：随处可见，3855步
- [拉鲁拉斯](https://wiki.52poke.com/wiki/拉鲁拉丝)：203和204号道路宝可追踪/地下洞窟，5140步
- [蘑蘑菇](https://wiki.52poke.com/wiki/蘑蘑菇)：大湿地，3855步
- [铁炮鱼](https://wiki.52poke.com/wiki/铁炮鱼)：联盟门口好钓竿垂钓，5140步
- [龙虾小兵](https://wiki.52poke.com/wiki/龙虾小兵)：神和镇厉害钓竿，3855步
- [溜溜糖球](https://wiki.52poke.com/wiki/溜溜糖球)：地下洞窟，3855步
- [长翅鸥](https://wiki.52poke.com/wiki/长翅鸥)：随处可见，5140步
- [鲤鱼王](https://wiki.52poke.com/wiki/鲤鱼王)：破钓竿垂钓，1285步

# 4. 起步流程

- step1: 准备2~3个头盖/盾甲化石，到黑金市博物馆找前台研究员复活
- step2: 确认含V个体值(默认至少3V)覆盖了6种能力
- step3: 携带红线与雌性咩利羊反复培育(此过程中可不考虑性格问题)。在达到5V前选取高V雌性，最后保留一只5V雄性咩利羊。大致过程如此：$2V\sim 3V\xrightarrow{换父母}3V\sim 5V$

# 5. 其他事项

由于地下洞窟捕获的Pokemon会随机习得蛋招式，因此善用横向遗传，可简化蛋招式的获得。但需注意横向遗传只能发生在同种Pokemon之间(即编号相同)。

# 6. 参考资料

- [神奇宝贝百科](https://wiki.52poke.com/wiki/)
- [タマゴの作り方と孵化でできること](https://kamigame.jp/pokemon_bdsp/page/182506788489309876.html)
- [【メタモン不要】タマゴグループ厳選！](https://www.youtube.com/watch?v=nZCfrID2WNM)
